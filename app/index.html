<!DOCTYPE html>
<html>
<head>
  <title>Weather App</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5">

  <h2>üå§Ô∏è Weather App</h2>

  <div id="loginForm">
    <h4>Login</h4>
    <input id="username" class="form-control" placeholder="Username"><br>
    <input id="password" class="form-control" type="password" placeholder="Password"><br>
    <button onclick="login()" class="btn btn-primary">Login</button>
    <hr>
  </div>
  <div id="registerForm" class="mt-5">
    <h4>Register</h4>
    <input id="regUsername" class="form-control" placeholder="Username"><br>
    <input id="regPassword" class="form-control" type="password" placeholder="Password"><br>
    <button onclick="register()" class="btn btn-secondary">Register</button>
  </div>
  <div class="card p-4 mt-4 shadow-sm" id="buttonGroup">
    <div class="btn-group mt-4" role="group" aria-label="Toggle Login/Register">
      <button id="loginTab" class="btn btn-outline-primary active" onclick="toggleForms('login')">
        Login
      </button>
      <button id="registerTab" class="btn btn-outline-primary" onclick="toggleForms('register')">
        Register
      </button>
    </div>
  </div>


  <div id="app" style="display:none">
    <p>üîê Logged in as: <span id="loggedInUser"></span></p>

    <input id="city" class="form-control" placeholder="Enter city"><br>
    <button onclick="getWeather()" class="btn btn-success">Get Weather</button><br><br>

    <div id="weatherResult"></div>
    <hr>

    <button onclick="getHistory()" class="btn btn-info">Show My Weather History</button>
    <ul id="history" class="list-group mt-3"></ul>
    <br>
    <button onclick="logout()" class="btn btn-danger">Logout</button>
  </div>

<script>
  const API_BASE = "";
  let token = localStorage.getItem("access_token");
  document.getElementById("registerForm").style.display = "none";
  document.getElementById("loginForm").style.display = "none";
  

  if (token) {
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("registerForm").style.display = "none"
    document.getElementById("app").style.display = "block";
    document.getElementById("loggedInUser").textContent = localStorage.getItem("username");
    document.getElementById("buttonGroup").style.display = "none"
  }
  function toggleForms(form) {
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");

  const loginTab = document.getElementById("loginTab");
  const registerTab = document.getElementById("registerTab");

  if (form === "register") {
    loginForm.style.display = "none";
    registerForm.style.display = "block";
    loginTab.classList.remove("active");
    registerTab.classList.add("active");
  } else {
    loginForm.style.display = "block";
    registerForm.style.display = "none";
    loginTab.classList.add("active");
    registerTab.classList.remove("active");
  }
}


  function register() {
  const username = document.getElementById("regUsername").value;
  const password = document.getElementById("regPassword").value;

  fetch(`${API_BASE}/register`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  })
  .then(res => res.json().then(data => ({ status: res.status, body: data })))
  .then(({ status, body }) => {
    if (status === 201) {
      alert("Registration successful! You can now log in.");
      toggleForms("login"); 
      
    } else {
      alert("Registration failed: " + (body.message || body.msg || "Unknown error"));
    }
  })
  .catch(err => {
    console.error("Register error:", err);
    alert("Server error during registration");
  });
  document.getElementById("regUsername").value = "";
  document.getElementById("regPassword").value = "";

}

  function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    fetch(`${API_BASE}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    })
    .then(res => res.json())
    .then(data => {
      if (data.access_token) {
        localStorage.setItem("access_token", data.access_token);
        localStorage.setItem("username", username);
        localStorage.setItem("api_key", data.api_key);
        location.reload();
      } else {
        alert("Login failed");
      }
    });
  }

  function getWeather() {
    const city = document.getElementById("city").value;
    const apiKey = localStorage.getItem("api_key");

    fetch(`${API_BASE}/weather?city=${city}&api_key=${apiKey}`, {
      headers: {
        Authorization: "Bearer " + localStorage.getItem("access_token")
      }
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("weatherResult").innerHTML = `
        <p><b>${data.city}</b>: ${data.temperature}¬∞C - ${data.description}</p>
      `;
    });
  }

  function getHistory() {
    fetch(`${API_BASE}/me/weather/history`, {
      headers: {
        Authorization: "Bearer " + localStorage.getItem("access_token")
      }
    })
    .then(res => res.json())
    .then(history => {
      const list = document.getElementById("history");
      list.innerHTML = "";
      history.forEach(entry => {
        const item = document.createElement("li");
        item.className = "list-group-item";
        item.textContent = `${entry.timestamp} ‚Üí ${entry.city}: ${entry.temperature}¬∞C (${entry.description})`;
        list.appendChild(item);
      });
    });
  }

  function logout() {
    fetch(`${API_BASE}/logout`, {
      method: "POST",
      headers: {
        Authorization: "Bearer " + localStorage.getItem("access_token")
      }
    });

    localStorage.removeItem("access_token");
    localStorage.removeItem("username");
    localStorage.removeItem("api_key")
    location.reload();
  }
</script>

</body>
</html>
